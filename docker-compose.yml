services:
  # ==================================================
  # AgriQCert PostgreSQL Database
  # Single database for both AgriQCert and Inji Certify
  # ==================================================
  postgres:
    image: postgres:15-alpine
    container_name: agriqcert_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # AgriQCert schema initialization
      - ./server/src/database/schema.sql:/docker-entrypoint-initdb.d/01-agriqcert-schema.sql
      # Inji Certify schema initialization (custom for AgriQCert integration)
      - ./inji-certify-schema.sql:/docker-entrypoint-initdb.d/02-inji-certify-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agriqcert_network

  # ==================================================
  # Redis Cache for Inji Certify
  # ==================================================
  redis:
    image: redis:alpine
    container_name: agriqcert_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agriqcert_network

  # ==================================================
  # Inji Certify Service
  # Verifiable Credential Issuance Service
  # ==================================================
  inji-certify:
    image: mosipid/inji-certify-with-plugins:0.13.0
    container_name: agriqcert_inji_certify
    restart: unless-stopped
    user: root
    ports:
      - "8090:8090"
    environment:
      - container_user=mosip
      - active_profile_env=default,agriqcert
      - SPRING_CONFIG_NAME=certify
      - SPRING_CONFIG_LOCATION=/home/mosip/config/
      - enable_certify_artifactory=false
      - download_hsm_client=false
      - mosip_certify_domain_url=http://localhost:8090
    volumes:
      # Configuration files
      - ./inji-certify/docker-compose/docker-compose-injistack/config/certify-default.properties:/home/mosip/config/certify-default.properties
      - ./inji-certify/docker-compose/docker-compose-injistack/config/certify-agriqcert.properties:/home/mosip/config/certify-agriqcert.properties
      # PKCS12 keystore directory (auto-generated)
      - ./inji-certify/docker-compose/docker-compose-injistack/data/CERTIFY_PKCS12:/home/mosip/CERTIFY_PKCS12
      # Postgres DataProvider Plugin
      - ./inji-certify/docker-compose/docker-compose-injistack/loader_path/certify:/home/mosip/additional_jars
    networks:
      - agriqcert_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/v1/certify/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==================================================
  # AgriQCert Server (Node.js Backend)
  # ==================================================
  # agriqcert-server:
  #   build:
  #     context: ./server
  #     dockerfile: Dockerfile
  #   container_name: agriqcert_server
  #   restart: unless-stopped
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - NODE_ENV=production
  #     - DB_HOST=postgres
  #     - DB_PORT=5432
  #     - DB_NAME=postgres
  #     - DB_USER=postgres
  #     - DB_PASSWORD=postgres
  #     # Inji Certify integration
  #     - INJI_CERTIFY_URL=http://inji-certify:8090/v1/certify
  #   volumes:
  #     - ./server:/app
  #     - /app/node_modules
  #   networks:
  #     - agriqcert_network
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     inji-certify:
  #       condition: service_healthy

networks:
  agriqcert_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

